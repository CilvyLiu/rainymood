<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Nova's Pensieve - Ultimate Physics</title>
    <style>
        :root { 
            --glass: rgba(255, 255, 255, 0.05); 
            --blur: blur(20px); 
            --border: rgba(255, 255, 255, 0.1); 
        }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #000; overflow: hidden; color: white; font-family: "PingFang SC", sans-serif; }
        
        #viewport { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-position: center; background-repeat: no-repeat; background-size: cover; z-index: 1; transition: 1s; filter: blur(8px) brightness(0.6); }
        #rainCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 3; pointer-events: none; }
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, transparent 30%, rgba(0,0,0,0.4) 100%); z-index: 2; pointer-events: none; }

        /* å·¦ä¾§å¯¼èˆª */
        .side-nav { position: fixed; left: 30px; top: 50%; transform: translateY(-50%); z-index: 100; display: flex; flex-direction: column; gap: 15px; }
        .nav-item { 
            width: 50px; height: 50px; background: var(--glass); backdrop-filter: var(--blur); 
            border: 1px solid var(--border); border-radius: 12px; display: flex; align-items: center; 
            justify-content: center; text-decoration: none; font-size: 20px; transition: 0.3s;
        }
        .nav-item:hover { background: rgba(255,255,255,0.1); transform: scale(1.1); border-color: #fff; }

        /* æ­£ä¸­é—´çºªå¾‹ */
        .center-container { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); z-index: 100; text-align: center; width: 400px; }
        .rule-card { 
            background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(25px); 
            border: 1px solid var(--border); border-radius: 20px; padding: 30px;
            display: none; transition: 0.5s; margin-bottom: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .rule-card h2 { letter-spacing: 5px; font-weight: 300; margin-bottom: 20px; color: #fff; }
        .rule-card p { font-size: 14px; line-height: 2.2; color: #ccc; text-align: left; }

        /* åº•éƒ¨æ§åˆ¶æ  */
        .bottom-bar { 
            position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); z-index: 100;
            display: flex; align-items: center; gap: 20px; background: var(--glass);
            backdrop-filter: var(--blur); padding: 12px 30px; border-radius: 50px; border: 1px solid var(--border);
        }

        button.magic-btn { 
            background: transparent; border: 1px solid #fff; color: #fff; 
            padding: 8px 25px; border-radius: 20px; cursor: pointer; font-size: 12px;
            letter-spacing: 2px; transition: 0.3s;
        }
        button.magic-btn:hover { background: #fff; color: #000; }

        select { background: transparent; color: #fff; border: 1px solid var(--border); padding: 5px 10px; border-radius: 10px; font-size: 12px; outline: none; }
        input[type=range] { accent-color: #fff; cursor: pointer; vertical-align: middle; width: 80px; }
        label { font-size: 11px; opacity: 0.6; text-transform: uppercase; letter-spacing: 1px; }
    </style>
</head>
<body onclick="initAudio()">

    <div id="viewport"></div>
    <div id="overlay"></div>
    <canvas id="rainCanvas"></canvas>

    <div class="side-nav">
        <a href="https://gringott.streamlit.app/" target="_blank" class="nav-item" title="å¤çµé˜">ğŸ¦</a>
        <a href="https://wwskygazer.streamlit.app/" target="_blank" class="nav-item" title="å—…å—…æ¢æµ‹">ğŸ¾</a>
        <a href="https://newscil.streamlit.app/" target="_blank" class="nav-item" title="é¢„è¨€æ—¥æŠ¥">ğŸ“œ</a>
        <a href="https://skygazer111.streamlit.app/" target="_blank" class="nav-item" title="æˆ˜ç•¥çœ‹æ¿">ğŸ”®</a>
    </div>

    <div class="center-container">
        <div class="rule-card" id="mainRule">
            <h2>çœ‹æ¿çºªå¾‹</h2>
            <p>
                1. <b>æ·±æ½œ</b>ï¼šè¿›å…¥å†¥æƒ³ç›†ï¼Œå‰¥ç¦»æƒ…ç»ªå¹²æ‰°ã€‚<br>
                2. <b>ç²¾å‡†</b>ï¼šæ¯ä¸€è¡Œæ•°æ®èƒŒåéƒ½æ˜¯çœŸå®çš„é€»è¾‘ã€‚<br>
                3. <b>éŸ§æ€§</b>ï¼šåœ¨æ³¢åŠ¨çš„é›¨å¹•ä¸­å¯»æ‰¾æ’å®šçš„è¶‹åŠ¿ã€‚<br>
                4. <b>è¿›åŒ–</b>ï¼šå¤ç›˜æ˜¯é€šå¾€å¤§å¸ˆä¹‹è·¯çš„å”¯ä¸€é˜¶æ¢¯ã€‚
            </p>
        </div>
        <button class="magic-btn" onclick="toggleRules(event)">ğŸ“œ OPEN RULES</button>
    </div>

    <div class="bottom-bar">
        <div id="clock" style="font-size: 14px; letter-spacing: 1px; margin-right: 15px; font-weight: 200;"></div>
        <label>VOL</label> <input type="range" id="vol" min="0" max="1" step="0.1" value="0.5" oninput="sync()">
        <label>RAIN</label> <input type="range" id="den" min="10" max="200" value="80" oninput="initRain()">
        <select onchange="handleSceneChange(this)">
            <option value="pensive.png|contain">ğŸº å†¥æƒ³ç›†</option>
            <option value="train.png|cover">ğŸš‚ éœæ ¼æ²ƒèŒ¨ç‰¹å¿«</option>
            <option value="window.png|cover">ğŸªŸ è½åœ°çª—å‰</option>
            <option value="beach.png|cover">ğŸ–ï¸ è´å£³å°å±‹</option>
        </select>
        <button id="pbtn" onclick="toggleAudio(event)" style="background: none; border: none; color: white; cursor: pointer; font-size: 16px;">â–¶</button>
    </div>

    <audio id="audio" loop src="0.m4a"></audio>

    <script>
        const canvas = document.getElementById('rainCanvas');
        const ctx = canvas.getContext('2d');
        const viewport = document.getElementById('viewport');
        const audio = document.getElementById('audio');
        const imgMask = new Image(); imgMask.src = 'drop-color.png'; 
        const imgAlpha = new Image(); imgAlpha.src = 'drop-alpha.png'; 
        const bgImg = new Image();
        let drops = [];
        const sprite = 5;

        function toggleRules(e) {
            e.stopPropagation();
            const card = document.getElementById('mainRule');
            const btn = e.target;
            const isOpen = card.style.display === 'block';
            card.style.display = isOpen ? 'none' : 'block';
            btn.innerText = isOpen ? 'ğŸ“œ OPEN RULES' : 'âœ¨ CLOSE RULES';
        }

        function handleSceneChange(select) {
            const [img, size] = select.value.split('|');
            viewport.style.backgroundImage = `url('${img}')`;
            viewport.style.backgroundSize = size;
            bgImg.src = img;
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            initRain();
        }

        function initRain() {
            drops = [];
            const density = document.getElementById('den').value;
            for (let i = 0; i < density; i++) {
                const isLarge = Math.random() > 0.8; 
                drops.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    si: Math.floor(Math.random() * sprite),
                    sj: Math.floor(Math.random() * sprite),
                    // å¤§å°æå¤§åŒ–ï¼šå¤§æ»´ 0.25-0.5, å°æ»´ 0.05-0.12
                    s: isLarge ? (Math.random() * 0.25 + 0.25) : (Math.random() * 0.07 + 0.05),
                    v: 0,
                    isLarge: isLarge,
                    wait: Math.random() * 300,
                    friction: Math.random() * 0.05 + 0.92,
                    swing: 0 
                });
            }
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (!imgMask.complete || !imgAlpha.complete) { requestAnimationFrame(draw); return; }

            drops.sort((a,b) => a.s - b.s).forEach(d => {
                const sw = imgMask.width / sprite;
                const sh = imgMask.height / sprite;
                const dw = sw * d.s;
                const dh = dw * (d.isLarge ? 1.6 : 1.3);

                ctx.save();
                // å¢åŠ æ‘†åŠ¨é€»è¾‘
                const currentX = d.x + Math.sin(d.swing) * (d.isLarge ? 2 : 0);
                ctx.translate(currentX, d.y);
                
                ctx.beginPath();
                ctx.moveTo(dw/2, 0);
                ctx.bezierCurveTo(dw, dh*0.3, dw, dh, dw/2, dh);
                ctx.bezierCurveTo(0, dh, 0, dh*0.3, dw/2, 0);
                ctx.clip(); 

                if (bgImg.complete) {
                    // æŠ˜å°„æ”¾å¤§å€ç‡æ ¹æ®å¤§å°è°ƒæ•´
                    const refract = d.isLarge ? 0.4 : 0.7;
                    ctx.drawImage(bgImg, currentX, d.y, dw*refract, dh*refract, -dw/2, -dh/2, dw*2, dh*2);
                }

                ctx.globalAlpha = d.isLarge ? 0.8 : 0.4;
                ctx.globalCompositeOperation = 'screen';
                ctx.drawImage(imgAlpha, d.si*sw, d.sj*sh, sw, sh, 0, 0, dw, dh);
                ctx.globalCompositeOperation = 'multiply';
                ctx.drawImage(imgMask, d.si*sw, d.sj*sh, sw, sh, 0, 0, dw, dh);
                ctx.restore();

                // ç‰©ç†ä¸‹è½é€»è¾‘
                if (d.isLarge || d.s > 0.1) {
                    d.wait--;
                    if (d.wait < 0) {
                        d.v += 0.2; 
                        d.v *= d.friction;
                        d.y += d.v;
                        d.swing += 0.1;
                        if (Math.random() > 0.98) { d.v *= 0.1; d.wait = Math.random()*80; }
                    }
                }
                if (d.y > canvas.height) {
                    d.y = -dh; d.x = Math.random()*canvas.width; d.v = 0; d.wait = Math.random()*400;
                }
            });
            requestAnimationFrame(draw);
        }

        function sync() { audio.volume = document.getElementById('vol').value; }
        function initAudio() { if(audio.paused) { audio.play(); pbtn.innerText = "â¸"; } }
        function toggleAudio(e) { e.stopPropagation(); audio.paused ? audio.play() : audio.pause(); pbtn.innerText = audio.paused ? "â–¶" : "â¸"; }
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('zh-CN', {hour12: false});
        }
        window.onload = () => {
            handleSceneChange({value: 'pensive.png|contain'});
            resize(); draw(); setInterval(updateClock, 1000); updateClock();
        };
        window.addEventListener('resize', resize);
    </script>
</body>
</html>

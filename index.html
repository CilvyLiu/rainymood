<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova's Pensieve - WebGL Ultra</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸº</text></svg>">
    <link rel="stylesheet" href="rain.css">
    <style>
        #container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; background-color: #000; }
        #overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 2; pointer-events: none; background: radial-gradient(circle at center, transparent 30%, rgba(0,0,0,0.4) 100%); }
        .side-nav, .center-container, .bottom-bar { z-index: 100 !important; }
    </style>
</head>
<body onclick="initAudio()">

    <div id="container"></div>
    <div id="overlay"></div>

    <div class="side-nav">
        <a href="https://gringott.streamlit.app/" target="_blank" class="nav-item" title="å¤çµé˜">ğŸ¦</a>
        <a href="https://wwskygazer.streamlit.app/" target="_blank" class="nav-item" title="å¥‡å…½é¥²è‚²">ğŸ¾</a>
        <a href="https://newscil.streamlit.app/" target="_blank" class="nav-item" title="é¢„è¨€å®¶æ—¥æŠ¥">ğŸ“œ</a>
        <a href="https://skygazer111.streamlit.app/" target="_blank" class="nav-item" title="å åœè¯¾">ğŸ”®</a>
    </div>

    <div class="center-container">
        <div class="rule-card" id="mainRule">
            <h2>çœ‹æ¿çºªå¾‹</h2>
            <p>
                <b>å£¹ Â· æ·±æ½œ</b>ï¼šå…¥å†¥æƒ³ç›†ï¼Œå¦‚æ°´æ»´èå…¥æ·±æ½­ã€‚<br>
                <b>è´° Â· ç²¾å‡†</b>ï¼šé€»è¾‘å¦‚å†°æ™¶ç¢è£‚ï¼Œæ•°æ®çš†æœ‰å› æœã€‚<br>
                <b>å Â· éŸ§æ€§</b>ï¼šçºµä½¿é›¨å¹•é®çœ¼ï¼Œäº¦è¦æ”«å–è¶‹åŠ¿ã€‚<br>
                <b>è‚† Â· è¿›åŒ–</b>ï¼šæ—¥æ‹±ä¸€å’ï¼Œä»¥æ­¤èº«ç‚¼å°±ç ´å±€ä¹‹æ³•ã€‚
            </p>
        </div>
        <button class="magic-btn" onclick="toggleRules(event)">FOCUS MODE</button>
    </div>

    <div class="bottom-bar">
        <div id="clock">00:00:00</div>
        <div class="control-group">
            <label>VOL</label> 
            <input type="range" id="vol" min="0" max="1" step="0.05" value="0.5" oninput="sync()">
        </div>
        
        <select id="weatherSelect" onchange="changeWeather()">
            <option value="drizzle">ğŸŒ¦ï¸ é˜µé›¨</option>
            <option value="rain">ğŸŒ§ï¸ ç»†é›¨</option>
            <option value="storm">â›ˆï¸ æš´é›¨</option>
            <option value="mega">ğŸŒªï¸ è¶…å¤§æš´é›¨</option>
        </select>

        <select id="sceneSelect" onchange="changeScene(this.value)">
            <option value="pensive.png">ç«è½¦</option>
            <option value="train.png">çª—æˆ·</option>
            <option value="window.png">éœ²è¥</option>
            <option value="beach.png">æµ·è¾¹</option>
            <option value="mountain.png">ä»™é¹¤</option>
        </select>
        <button id="pbtn" onclick="toggleAudio(event)">â–¶</button>
    </div>

    <audio id="audio_bg" loop src="0.m4a"></audio>
    <audio id="audio_scene" loop></audio>

    <script src="rain.js"></script>
    <script>
        const abg = document.getElementById('audio_bg');
        const asc = document.getElementById('audio_scene');
        const pbtn = document.getElementById('pbtn');

        const SCENE_ASSETS = {
            'pensive.png':  { audio: 'train.mp3' },
            'train.png':    { audio: 'window_rain.mp3' },
            'window.png':   { audio: 'camp.mp3' },
            'beach.png':    { audio: 'ocean.mp3' },
            'mountain.png': { audio: 'zen.mp3' }
        };

        function initAudio() {
            if (abg.paused) {
                abg.play().catch(() => {});
                if (asc.src) asc.play().catch(() => {});
                pbtn.innerText = "â¸";
            }
            document.body.onclick = null;
        }

        window.toggleAudio = function(e) {
            e.stopPropagation();
            if (abg.paused) {
                abg.play(); if (asc.src) asc.play();
                pbtn.innerText = "â¸";
            } else {
                abg.pause(); asc.pause();
                pbtn.innerText = "â–¶";
            }
        };

        function sync() { 
            const v = document.getElementById('vol').value;
            abg.volume = asc.volume = v; 
        }

        window.changeScene = function(val) {
            if (window.rainEngine) {
                window.rainEngine.updateBackground(val);
                const asset = SCENE_ASSETS[val];
                if (asset) {
                    asc.src = asset.audio;
                    asc.play().catch(() => {});
                }
            }
        };

        // --- æ ¸å¿ƒç‰©ç†è¡¨ï¼šæ§åˆ¶å°ºå¯¸ã€é€Ÿåº¦ä¸æ“¦é™¤é€Ÿåº¦ ---
        window.changeWeather = function() {
            const weather = document.getElementById('weatherSelect').value;
            if (window.rainEngine) {
                const weatherMap = {
                    // drizzle: ç»†å°ï¼ŒæŒ‚å£æ—¶é—´é•¿ (fade: 0.8)
                    drizzle: { chance: 0.1, size: [12, 25], fade: 0.8, gravity: 800 },
                    // rain: æ ‡å‡†
                    rain:    { chance: 0.3, size: [20, 40], fade: 2.5, gravity: 1200 },
                    // storm: è¾ƒå¤§ï¼Œæ¶ˆå¤±å¿«
                    storm:   { chance: 0.6, size: [30, 55], fade: 5.0, gravity: 1800 },
                    // mega: è¶…é«˜é¢‘ç‡ï¼Œå†²åˆ·æå¿« (fade: 12.0)ï¼Œè§†è§‰éœ‡æ’¼
                    mega:    { chance: 0.95, size: [40, 65], fade: 12.0, gravity: 2800 }
                };
                const opt = weatherMap[weather];
                window.rainEngine.spawnChance = opt.chance;
                window.rainEngine.sizeRange = opt.size;
                window.rainEngine.fadeSpeed = opt.fade;
                window.rainEngine.customGravity = opt.gravity; // è”åŠ¨é‡åŠ›
            }
        };

        function toggleRules(e) {
            e.stopPropagation();
            const card = document.getElementById('mainRule');
            card.style.display = (card.style.display === 'none') ? 'block' : 'none';
        }

        function updateClock() {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString('zh-CN', {hour12: false});
        }

        setInterval(updateClock, 1000);
        updateClock();
        sync();
    </script>
</body>
</html>

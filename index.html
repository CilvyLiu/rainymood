import streamlit as st
import base64
from pathlib import Path
from datetime import datetime, timedelta, timezone

# ===================== 1. åŸºç¡€é…ç½® =====================
st.set_page_config(page_title="Nova's Pensieve", layout="wide", initial_sidebar_state="collapsed")

TZ_CHINA = timezone(timedelta(hours=8))
now_china = datetime.now(timezone.utc).astimezone(TZ_CHINA)

def get_base64(file_path):
    try:
        if Path(file_path).exists():
            with open(file_path, "rb") as f:
                return base64.b64encode(f.read()).decode()
        return ""
    except: return ""

# ===================== 2. æ ¸å¿ƒæ¶æ„æ³¨å…¥ =====================
def inject_pensieve_system(bg_file, audio_file):
    bg_base64 = get_base64(bg_file)
    audio_base64 = get_base64(audio_file)
    is_pensieve = "pensieve" in bg_file
    
    # åŠ¨æ€èƒŒæ™¯æ ·å¼
    bg_style = f"""
        background: url("data:image/gif;base64,{bg_base64}");
        background-repeat: no-repeat;
        background-position: center;
        background-size: {"400px" if is_pensieve else "cover"};
        background-color: black;
    """

    st.markdown(f"""
    <style>
    .stApp {{
        {bg_style}
        transition: all 1.5s ease-in-out;
    }}

    /* é›¨æ»´ç»ç’ƒæ»¤é•œ - å…¨å±å åŠ  */
    .stApp::after {{
        content: "";
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background-image: url("https://www.transparenttextures.com/patterns/glass-pass.png");
        opacity: 0.25;
        pointer-events: none;
        z-index: 1;
    }}

    /* è°ƒè‰²è’™ç‰ˆ */
    .stApp::before {{
        content: "";
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: {"rgba(0,0,0,0.8)" if is_pensieve else "rgba(10, 20, 30, 0.4)"};
        backdrop-filter: brightness(0.7);
        z-index: -1;
    }}

    /* å¯¼èˆªå¡ç‰‡ */
    .nav-card {{
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        transition: 0.4s;
        text-decoration: none !important;
        color: white !important;
        backdrop-filter: blur(10px);
        display: block;
    }}
    .nav-card:hover {{
        background: rgba(0, 212, 255, 0.1);
        border: 1px solid #00d4ff;
        transform: translateY(-5px);
    }}

    header, footer {{visibility: hidden;}}
    </style>
    
    <audio autoplay loop id="rainAudio">
        <source src="data:audio/mp3;base64,{audio_base64}" type="audio/mp3">
    </audio>
    
    <script>
        var audio = document.getElementById("rainAudio");
        audio.volume = 0.5;
        // æ ¸å¿ƒäº¤äº’ï¼šç‚¹å‡»å±å¹•ä»»ä½•åœ°æ–¹æ’­æ”¾é›¨å£°
        document.addEventListener('click', function() {{
            audio.play();
        }});
    </script>
    """, unsafe_allow_html=True)

# ===================== 3. åœºæ™¯é€»è¾‘ =====================
SCENE_FILES = {
    "ğŸº å†¥æƒ³ç›†": "pensieve.png",
    "ğŸš‚ ç«è½¦": "train.png",
    "ğŸªŸ è½åœ°çª—": "window.png",
    "ğŸ–ï¸ æ²™æ»©": "beach.png",
    "â›°ï¸ å±±é¡¶": "mountain.png"
}

if "current_scene_file" not in st.session_state:
    st.session_state.current_scene_file = SCENE_FILES["ğŸº å†¥æƒ³ç›†"]

inject_pensieve_system(st.session_state.current_scene_file, "0.m4a")

# ===================== 4. UI å¸ƒå±€ =====================
# é¡¶éƒ¨æ ‡é¢˜
st.markdown(f"<h2 style='text-align: center; color: white; font-family: serif; letter-spacing: 10px; opacity: 0.7;'>THE PENSIEVE</h2>", unsafe_allow_html=True)
st.markdown(f"<p style='text-align: center; color: #555; font-size: 12px;'>{now_china.strftime('%H:%M:%S')} CST</p>", unsafe_allow_html=True)

# ç•™å‡ºä¸­é—´èƒŒæ™¯åŒºåŸŸï¼ˆå†¥æƒ³ç›†ä½ç½®ï¼‰
st.markdown("<br><br><br><br><br><br><br><br><br><br><br><br>", unsafe_allow_html=True)

# åŠŸèƒ½å¡ç‰‡
cols = st.columns(4)
links = [
    ("ğŸ¦", "å¤çµé˜", "https://gringott.streamlit.app/"),
    ("ğŸ¾", "å—…å—…æ¢æµ‹", "https://wwskygazer.streamlit.app/"),
    ("ğŸ“œ", "é¢„è¨€æ—¥æŠ¥", "https://newscil.streamlit.app/"),
    ("ğŸ”®", "æˆ˜ç•¥çœ‹æ¿", "https://skygazer111.streamlit.app/")
]

for i, (emoji, name, url) in enumerate(links):
    with cols[i]:
        st.markdown(f"""
        <a href="{url}" target="_blank" class="nav-card">
            <h2 style="margin:0;">{emoji}</h2>
            <div style="font-size: 14px; margin-top:5px; letter-spacing:2px;">{name}</div>
        </a>
        """, unsafe_allow_html=True)

# åº•éƒ¨ç¯å¢ƒåˆ‡æ¢
st.markdown("<br><br>", unsafe_allow_html=True)
with st.expander("âœ¨ è°ƒè°å†¥æƒ³ç¯å¢ƒ"):
    sc_btns = st.columns(len(SCENE_FILES))
    for i, (name, file) in enumerate(SCENE_FILES.items()):
        if sc_btns[i].button(name):
            st.session_state.current_scene_file = file
            st.rerun()

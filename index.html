<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Nova's Pensieve - Physical Realism</title>
    <style>
        :root { 
            --glass: rgba(255, 255, 255, 0.03); 
            --blur: blur(25px); 
            --border: rgba(255, 255, 255, 0.08); 
        }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #000; overflow: hidden; color: white; font-family: "PingFang SC", sans-serif; }
        
        /* èƒŒæ™¯ä¿æŒæ¨¡ç³Šï¼Œé›¨æ»´å†…éƒ¨ä¿æŒæ¸…æ™° */
        #viewport { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-position: center; background-repeat: no-repeat; background-size: cover; z-index: 1; transition: 1.5s; filter: blur(10px) brightness(0.5); }
        #rainCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 3; pointer-events: none; }
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, transparent 20%, rgba(0,0,0,0.5) 100%); z-index: 2; pointer-events: none; }

        .side-nav { position: fixed; left: 25px; top: 50%; transform: translateY(-50%); z-index: 100; display: flex; flex-direction: column; gap: 15px; }
        .nav-item { 
            width: 45px; height: 45px; background: var(--glass); backdrop-filter: var(--blur); 
            border: 1px solid var(--border); border-radius: 50%; display: flex; align-items: center; 
            justify-content: center; text-decoration: none; font-size: 18px; transition: 0.4s;
        }
        .nav-item:hover { background: rgba(255,255,255,0.1); transform: translateX(5px); border-color: #fff; }

        .center-container { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); z-index: 100; text-align: center; width: 500px; }
        .rule-card { 
            background: rgba(10, 10, 10, 0.4); backdrop-filter: blur(40px); 
            border: 1px solid var(--border); border-radius: 24px; padding: 40px;
            display: none; transition: 0.5s ease-in-out; margin-bottom: 25px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.8);
        }
        .rule-card h2 { letter-spacing: 8px; font-weight: 200; margin-bottom: 25px; color: #fff; opacity: 0.9; }
        .rule-card p { font-size: 15px; line-height: 2.5; color: #bbb; text-align: justify; }

        .bottom-bar { 
            position: fixed; bottom: 35px; left: 50%; transform: translateX(-50%); z-index: 100;
            display: flex; align-items: center; gap: 20px; background: rgba(0,0,0,0.4);
            backdrop-filter: blur(20px); padding: 10px 30px; border-radius: 50px; border: 1px solid var(--border);
        }

        button.magic-btn { 
            background: transparent; border: 1px solid rgba(255,255,255,0.4); color: #fff; 
            padding: 10px 35px; border-radius: 30px; cursor: pointer; font-size: 11px;
            letter-spacing: 3px; transition: 0.3s;
        }
        button.magic-btn:hover { background: #fff; color: #000; border-color: #fff; }

        select { background: transparent; color: #fff; border: none; padding: 5px; cursor: pointer; font-size: 12px; outline: none; }
        input[type=range] { accent-color: #fff; width: 70px; height: 3px; }
        label { font-size: 9px; opacity: 0.5; letter-spacing: 1px; }
    </style>
</head>
<body onclick="initAudio()">

    <div id="viewport"></div>
    <div id="overlay"></div>
    <canvas id="rainCanvas"></canvas>

    <div class="side-nav">
        <a href="https://gringott.streamlit.app/" target="_blank" class="nav-item">ğŸ¦</a>
        <a href="https://wwskygazer.streamlit.app/" target="_blank" class="nav-item">ğŸ¾</a>
        <a href="https://newscil.streamlit.app/" target="_blank" class="nav-item">ğŸ“œ</a>
        <a href="https://skygazer111.streamlit.app/" target="_blank" class="nav-item">ğŸ”®</a>
    </div>

    <div class="center-container">
        <div class="rule-card" id="mainRule">
            <h2>çœ‹æ¿çºªå¾‹</h2>
            <p>
                <b>å£¹ Â· æ·±æ½œ</b>ï¼šå…¥å†¥æƒ³ç›†ï¼Œå¦‚æ°´æ»´èå…¥æ·±æ½­ï¼Œå‰¥ç¦»ä¸‡åƒæ‚å¿µã€‚<br>
                <b>è´° Â· ç²¾å‡†</b>ï¼šé€»è¾‘å¦‚å†°æ™¶ç¢è£‚ï¼Œæ¯ä¸€è¡Œæ•°æ®çš†æœ‰å› æœã€‚<br>
                <b>å Â· éŸ§æ€§</b>ï¼šçºµä½¿é›¨å¹•é®çœ¼ï¼Œäº¦è¦åœ¨æ³¢åŠ¨ä¸­æ”«å–æ°¸æ’ä¹‹è¶‹åŠ¿ã€‚<br>
                <b>è‚† Â· è¿›åŒ–</b>ï¼šæ—¥æ‹±ä¸€å’ï¼Œå¤ç›˜ä¸ºé­‚ï¼Œä»¥æ­¤èº«ç‚¼å°±ç ´å±€ä¹‹æ³•ã€‚
            </p>
        </div>
        <button class="magic-btn" onclick="toggleRules(event)">FOCUS MODE</button>
    </div>

    <div class="bottom-bar">
        <div id="clock" style="font-size: 13px; letter-spacing: 2px; font-weight: 200; min-width: 80px;"></div>
        <label>VOLUME</label> <input type="range" id="vol" min="0" max="1" step="0.1" value="0.5" oninput="sync()">
        <label>STORM</label> <input type="range" id="den" min="20" max="300" value="100" oninput="initRain()">
        <select onchange="handleSceneChange(this)">
            <option value="pensive.png|contain">ğŸº å†¥æƒ³ç›†</option>
            <option value="train.png|cover">ğŸš‚ éœæ ¼æ²ƒèŒ¨</option>
            <option value="window.png|cover">ğŸªŸ è½åœ°çª—</option>
            <option value="beach.png|cover">ğŸ–ï¸ è´å£³å°å±‹</option>
        </select>
        <button id="pbtn" onclick="toggleAudio(event)" style="background: none; border: none; color: white; cursor: pointer; font-size: 14px; opacity: 0.7;">â–¶</button>
    </div>

    <audio id="audio" loop src="0.m4a"></audio>

    <script>
        const canvas = document.getElementById('rainCanvas');
        const ctx = canvas.getContext('2d');
        const viewport = document.getElementById('viewport');
        const audio = document.getElementById('audio');
        const imgMask = new Image(); imgMask.src = 'drop-color.png'; 
        const imgAlpha = new Image(); imgAlpha.src = 'drop-alpha.png'; 
        const bgImg = new Image();
        let drops = [];
        const sprite = 5;

        function toggleRules(e) {
            e.stopPropagation();
            const card = document.getElementById('mainRule');
            const isOpen = card.style.display === 'block';
            card.style.display = isOpen ? 'none' : 'block';
            e.target.innerText = isOpen ? 'FOCUS MODE' : 'RELEASE';
        }

        function handleSceneChange(select) {
            const [img, size] = select.value.split('|');
            viewport.style.backgroundImage = `url('${img}')`;
            viewport.style.backgroundSize = size;
            bgImg.src = img;
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            initRain();
        }

        function initRain() {
            drops = [];
            const density = document.getElementById('den').value;
            for (let i = 0; i < density; i++) {
                const isHeavy = Math.random() > 0.85;
                drops.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    si: Math.floor(Math.random() * sprite),
                    sj: Math.floor(Math.random() * sprite),
                    // å°ºå¯¸è¿›ä¸€æ­¥æ”¾å¤§ï¼Œå¤§æ»´ 0.3-0.6
                    s: isHeavy ? (Math.random() * 0.3 + 0.3) : (Math.random() * 0.1 + 0.05),
                    v: 0,
                    isHeavy: isHeavy,
                    tension: Math.random() * 0.2 + 0.8, // è¡¨é¢å¼ åŠ›ç³»æ•°
                    lastY: 0,
                    trail: []
                });
            }
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (!imgMask.complete || !imgAlpha.complete) { requestAnimationFrame(draw); return; }

            // æ·±åº¦æ’åºï¼šç¡®ä¿å¤§æ»´è¦†ç›–å°æ»´
            drops.sort((a,b) => a.s - b.s).forEach(d => {
                const sw = imgMask.width / sprite;
                const sh = imgMask.height / sprite;
                const dw = sw * d.s;
                const dh = dw * (d.isHeavy ? 1.5 : 1.2);

                ctx.save();
                ctx.translate(d.x, d.y);
                
                // ç‰©ç†è£å‰ª
                ctx.beginPath();
                ctx.moveTo(dw/2, 0);
                ctx.bezierCurveTo(dw, dh*0.3, dw, dh, dw/2, dh);
                ctx.bezierCurveTo(0, dh, 0, dh*0.3, dw/2, 0);
                ctx.clip(); 

                // æ ¸å¿ƒï¼šæŠ˜å°„æ¨¡æ‹Ÿ
                if (bgImg.complete) {
                    // å‡¸é€é•œåŸç†ï¼šå†…éƒ¨ç”»é¢åè½¬å¹¶æ”¾å¤§
                    ctx.scale(1, -1); 
                    ctx.drawImage(bgImg, d.x, d.y, dw*0.4, dh*0.4, -dw/2, -dh/2, dw, dh);
                    ctx.scale(1, -1);
                }

                // è´¨æ„Ÿå åŠ 
                ctx.globalAlpha = d.isHeavy ? 0.9 : 0.5;
                ctx.globalCompositeOperation = 'screen';
                ctx.drawImage(imgAlpha, d.si*sw, d.sj*sh, sw, sh, 0, 0, dw, dh);
                ctx.globalCompositeOperation = 'multiply';
                ctx.drawImage(imgMask, d.si*sw, d.sj*sh, sw, sh, 0, 0, dw, dh);
                ctx.restore();

                // éçº¿æ€§ç‰©ç†å¼•æ“
                if (d.isHeavy) {
                    // æ¨¡æ‹Ÿè¡¨é¢å¼ åŠ›ï¼šåªæœ‰é‡åŠ›ç§¯ç´¯åˆ°ä¸€å®šç¨‹åº¦æ‰ä¼šå‘ä¸‹æ»‘åŠ¨
                    if (Math.random() > 0.96) d.v += 0.8; 
                    d.v *= d.tension; 
                    d.y += d.v;
                    d.x += Math.sin(d.y/50) * 0.3; // è›‡å½¢ä¸‹æ»‘

                    // é‡åˆ°â€œé˜»åŠ›â€ç¬é—´å‡é€Ÿ
                    if (Math.random() > 0.99) {
                        d.v *= 0.05;
                    }
                } else {
                    // å°æ°´æ»´ç¼“æ…¢è •åŠ¨
                    d.y += 0.1;
                }

                if (d.y > canvas.height) {
                    d.y = -dh; d.x = Math.random()*canvas.width; d.v = 0;
                }
            });
            requestAnimationFrame(draw);
        }

        function sync() { audio.volume = document.getElementById('vol').value; }
        function initAudio() { if(audio.paused) { audio.play(); pbtn.innerText = "â¸"; } }
        function toggleAudio(e) { e.stopPropagation(); audio.paused ? audio.play() : audio.pause(); pbtn.innerText = audio.paused ? "â–¶" : "â¸"; }
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('zh-CN', {hour12: false});
        }
        window.onload = () => {
            handleSceneChange({value: 'pensive.png|contain'});
            resize(); draw(); setInterval(updateClock, 1000); updateClock();
        };
        window.addEventListener('resize', resize);
    </script>
</body>
</html>
